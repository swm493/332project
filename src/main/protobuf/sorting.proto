syntax = "proto3";

package sorting;

message ProtoKey {
  bytes key = 1;
}

message RegisterRequest {
  string workerId = 1;
}

message RegisterReply {
  int32 assignedState = 1;
  // 등록 시에는 편의상 바로 받아도 되지만, 일관성을 위해 제거하거나 유지할 수 있습니다.
  // 여기서는 빠른 복구를 위해 유지하되, Heartbeat에서는 확실히 제거합니다.
  repeated ProtoKey splitters = 2;
  repeated string allWorkerIds = 3;
}

message SampleRequest {
  string workerId = 1;
  repeated ProtoKey samples = 2;
}

message SampleReply {
  bool ack = 1;
}

message NotifyRequest {
  string workerId = 1;
  string message = 2;
}

message NotifyReply {
  bool ack = 1;
}

message HeartbeatRequest {
  string worker_id = 1;
}

message HeartbeatReply {
  enum WorkerState {
    Unregistered = 0;
    Sampling = 1;
    Shuffling = 2;
    Merging = 3;
    Done = 4;
    Failed = 5;
    Waiting = 6;
  }
  WorkerState state = 1;
  // splitters와 all_worker_ids 제거됨 (GetGlobalState로 이동)
}

// [신규] 전역 상태(스플리터, 워커 목록 등) 요청 메시지
message GetGlobalStateRequest {
  string workerId = 1;
}

// [신규] 전역 상태 응답 메시지
message GetGlobalStateReply {
  repeated ProtoKey splitters = 1;
  repeated string allWorkerIds = 2;
}

service SortingService {
  rpc RegisterWorker (RegisterRequest) returns (RegisterReply);
  rpc Heartbeat (HeartbeatRequest) returns (HeartbeatReply);
  rpc SubmitSamples (SampleRequest) returns (SampleReply);
  rpc NotifyShuffleComplete (NotifyRequest) returns (NotifyReply);
  rpc NotifyMergeComplete (NotifyRequest) returns (NotifyReply);

  // [신규] 무거운 데이터는 별도 요청으로 분리
  rpc GetGlobalState (GetGlobalStateRequest) returns (GetGlobalStateReply);
}