syntax = "proto3";
package sorting;

import "common.proto";

message RegisterRequest {
  NodeAddress workerAddress = 1;
}

message RegisterReply {
  int32 assignedState = 1;
  WorkerEndpoint workerEndpoint = 2;
  repeated ProtoKey splitters = 3;
  repeated WorkerEndpoint allWorkerEndpoints = 4;
}

message SampleRequest {
  WorkerEndpoint workerEndpoint = 1;
  repeated ProtoKey samples = 2;
}

message SampleReply {
  bool ack = 1;
}

message NotifyRequest {
  WorkerEndpoint workerEndpoint = 1;
  string message = 2;
}

message NotifyReply {
  bool ack = 1;
}

message HeartbeatRequest {
  WorkerEndpoint workerEndpoint = 1;
}

message HeartbeatReply {
  enum WorkerHeartState {
    Unregistered = 0;
    Sampling = 1;
    Shuffling = 2;
    Merging = 3;
    Done = 4;
    Failed = 5;
    Waiting = 6;
  }
  WorkerHeartState state = 1;
}

message GetGlobalStateRequest {
  WorkerEndpoint workerEndpoint = 1;
}

message GetGlobalStateReply {
  repeated ProtoKey splitters = 1;
  repeated WorkerEndpoint allWorkerEndpoints = 2;
}

message ShuffleReadyRequest {
  WorkerEndpoint workerEndpoint = 1;
}

message ShuffleReadyReply {
  bool allReady = 1;
}

service MasterService {
  rpc RegisterWorker (RegisterRequest) returns (RegisterReply);
  rpc SubmitSamples (SampleRequest) returns (SampleReply);

  rpc Heartbeat (HeartbeatRequest) returns (HeartbeatReply);
  rpc GetGlobalState (GetGlobalStateRequest) returns (GetGlobalStateReply);

  rpc CheckShuffleReady (ShuffleReadyRequest) returns (ShuffleReadyReply);

  rpc NotifyShuffleComplete (NotifyRequest) returns (NotifyReply);
  rpc NotifyMergeComplete (NotifyRequest) returns (NotifyReply);
}